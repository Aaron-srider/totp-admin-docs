# 后端接口资源

后端的接口实际上是一种资源，为了方便后端资源的开发与维护，本系统将后端资源划分为以下3种：
* 用户使用的资源（下称用户接口）
* 第三方应用使用的资源（下称开放接口）
* 所有人都能使用的资源（下称通用接口）。

不同资源的受众、用途以及重要程度不尽相同，导致它们的开放性也有强有弱。

## 资源的开放性

用户接口和开放接口暴露的数据设计每个用户的私人信息，因此需要较为严格的鉴权机制来管控；相比之下，通用接口通常标识着一些不重要的资源，比如系统中的一些常量，因此不需要任何权限控制，来者不拒。

## 接口的权限鉴别机制

**令牌**

无论是用户接口，还是开放接口，它们的访问都受到管制。必须有一套机制来实现这个目的。本系统采用token鉴权机制。

token鉴权机制的核心就是，在访问接口前，需要主动向服务器请求认证，在认证通过后得到服务器颁发的令牌，并访问接口时，在请求中携带由本系统颁发的、合法的令牌，也就是上文提及的 token ，以表明来访者的身份。

使用token鉴权的优势有很多，其一就是能保证系统后端是无状态的，这能简化系统后端的业务流程，也能保证系统在意外崩溃或处于维护状态时不丢失重要信息。token鉴权的第二个优势就是它相较于传统鉴权方式有着更高的灵活性。派发token的接口和鉴别token的逻辑可以不耦合在一起，同一个token也可以在一定时间内重复使用，这能有效避免每次需要鉴权时都需要上传自己的用户名和密码（因为这样做极增大了隐私信息泄露的风险）。与此同时，后端的设计者可以轻易地在token中设置不同的权限鉴别信息，已达到灵活鉴权的目的。


在本系统中，用户接口的token称为login-token，开放接口的token称为app-access-token。虽然二者在名称上有所差别，但是二者的设计意图都是一致的，它们都是接口受众的临时凭证。

在本系统中，无论是login-token还是app-access-token，其中只携带了相关实体的id，login-token中携带的是系统用户的id，app-access-token中则携带了第三方程序的id。

**令牌的颁发**

login-token的颁发由接口 /auth_user 接口颁发。前端访问该接口时，需要携带用户名和密码，/auth_user 接口认证用户名密码无误后，下发用户令牌。前端妥善保存令牌，在访问用户接口时，将该令牌置于header login-token 中，以表明用户身份。
app-access-token由接口 /app_access_key/apply_access_token 接口颁发，与 /auth_user 一样，来访者将 appid 和 appsecret 置于请求中，由接口认证通过后，下发token给调用者。前端妥善保存令牌，在访问开放接口时，将该令牌置于header app-access-token 中，以表明第三方应用身份。

**令牌失效**

上述提及的两种令牌都有一定的时效，调用者在必要的时候可以通过令牌时效查询接口查询令牌是否有效，如果令牌失效了，则需要重新向相应的令牌颁发接口申请新的令牌。login-token 的时效查询接口是 /token_expire，app-access-token 的时效查询接口是 /app_access_token/token-expire。


## 用户接口

用户接口，顾名思义，就是专门开放给系统用户的接口。之所以叫用户接口，并不是因为用户需要手动调用这些接口来获取信息，而是因为负责与用户交互的前端需要通过这些接口来获取数据并展示给用户。

既然用户接口的受众是用户，那么这些接口的访问者必须要证明自己是系统的合法用户。为了达到这个目的，本系统重规定，用户接口的访问者（也就是系统前端），必须在HTTP请求头中携带用户的token，以证明自己是系统中的合法用户。一个示例请求如下：

``` shell
curl -H "login-token: eyJhbGciOiJIUzUxMiIsInppcCI6I" "http://hostname:port/apiname"
```

在上述请求示例中：请求头中的 login-token 就用于承载能表明用户身份的token或其他信息。 

## 用户Token认证机制的实现

**颁发login-token**

前端调用接口 /auth_user，并携带用户的用户名和密码，如果经查询，数据库中有相应的用户记录，则生成token并通过响应返回前端。

**token方案**

login-token的有效期设置为两天左右。如果使用redis等缓存延时来实现时限鉴别则不太合适，因为如果redis在某些意外的情况下崩溃，那么所有的login-token都将重新计时，当然也可以在此基础上设计其他保险措施，不过这样就显得太过复杂。如果能利用token本身携带信息的能力，存储token颁发的时间，就能轻松鉴别token是否失效。

经过一番调研，决定采用比较成熟的JWT作为token的实现。只要在颁发token时将颁发时间点和token时效一并设置到token中，就相当于将token时效信息内嵌到了token自身。这样不但合理利用了token能携带信息的特性，也省去了额外的计时措施，降低了系统的复杂度。

**token认证的实现**


## 开放接口

开放接口则本系统重指的是专门开放给第三方应用的接口。每个用户可以通过web端申请自己的第三方APP，然后通过接口 /app_access_key/apply_access_token 接口获取 app-access-token，在向开放接口发送请求时，将 app-access-token 置于请求Header中即可。